<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SPMS - نظام إدارة الطلاب والأرباح</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
/* ===== FONTS & ROOT ===== */
* { margin:0; padding:0; box-sizing:border-box; }

:root {
  --primary: #5B0E14;
  --primary-light: #8B1E2A;
  --accent: #D9C56A;
  --accent-dark: #B8A050;
  --bg: #F1E194;
  --bg-soft: #EDD87E;
  --card: #FFFFFF;
  --text: #5B0E14;
  --text-muted: #8B6219;
  --border: #E5D88A;
  --shadow: 0 2px 12px rgba(91,14,20,0.1);
  --shadow-lg: 0 8px 32px rgba(91,14,20,0.18);
  --radius: 14px;
  --sidebar-w: 72px;
  --header-h: 66px;
}
[data-theme="dark"] {
  --primary: #F1E194;
  --primary-light: #D9C56A;
  --accent: #5B0E14;
  --accent-dark: #4A0B10;
  --bg: #0F0304;
  --bg-soft: #1a0507;
  --card: #1E0608;
  --text: #F1E194;
  --text-muted: #D9C56A;
  --border: #3D1417;
  --shadow: 0 2px 12px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.6);
}

html, body {
  font-family: 'Cairo', 'Tajawal', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100%;
  overflow: hidden;
  transition: background .3s, color .3s;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius:3px; }

/* ===== LOGIN SCREEN ===== */
.login-screen {
  position:fixed; inset:0; z-index:9999;
  display:flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, #3D0A0E 0%, #5B0E14 30%, #8B1E2A 60%, #C4A84F 100%);
  background-size: 400% 400%;
  animation: gradAnim 8s ease infinite;
}
@keyframes gradAnim {
  0%,100%{background-position:0% 50%}
  50%{background-position:100% 50%}
}
.login-screen::before {
  content:''; position:absolute; inset:0;
  background: radial-gradient(ellipse at 30% 50%, rgba(241,225,148,0.08) 0%, transparent 60%),
              radial-gradient(ellipse at 70% 30%, rgba(91,14,20,0.3) 0%, transparent 50%);
  pointer-events:none;
}
.login-card {
  position:relative; z-index:1;
  background: rgba(255,255,255,0.97);
  backdrop-filter: blur(20px);
  border-radius:22px;
  padding: 44px 40px 36px;
  width: 420px;
  max-width: calc(100vw - 40px);
  box-shadow: 0 24px 80px rgba(0,0,0,0.35);
  animation: cardIn .7s cubic-bezier(.22,1,.36,1);
}
@keyframes cardIn {
  from{opacity:0;transform:translateY(40px) scale(.96)}
  to{opacity:1;transform:none}
}
.login-brand {
  text-align:center; margin-bottom:28px;
}
.login-logo-wrap {
  width:80px; height:80px; margin:0 auto 14px;
  background: linear-gradient(135deg, #5B0E14, #8B1E2A);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:34px; color:#F1E194;
  box-shadow: 0 8px 28px rgba(91,14,20,0.35);
}
.login-title {
  font-family:'Cairo',sans-serif;
  font-size:26px; font-weight:800;
  color:#5B0E14; letter-spacing:1px;
}
.login-sub {
  font-size:13px; color:#8B6219;
  font-weight:500; margin-top:3px;
}
.login-field {
  position:relative; margin-bottom:16px;
}
.login-field-icon {
  position:absolute; right:14px; top:50%; transform:translateY(-50%);
  color:#8B6219; font-size:15px; pointer-events:none;
}
.login-input {
  width:100%; padding:13px 42px 13px 14px;
  border:1.5px solid #E5D88A;
  border-radius:10px; font-size:14px;
  font-family:'Cairo',sans-serif;
  background:#FDFAF0; color:#5B0E14;
  transition:border .2s, box-shadow .2s;
}
.login-input:focus {
  outline:none; border-color:#5B0E14;
  box-shadow: 0 0 0 3px rgba(91,14,20,0.1);
}
.login-input::placeholder { color:#b9a070; }
.btn-login {
  width:100%; padding:14px;
  background: linear-gradient(135deg, #5B0E14, #8B1E2A);
  color:#F1E194; border:none; border-radius:10px;
  font-size:15px; font-weight:700; font-family:'Cairo',sans-serif;
  cursor:pointer; transition:all .25s;
  display:flex; align-items:center; justify-content:center; gap:8px;
  margin-bottom:12px;
}
.btn-login:hover {
  transform:translateY(-2px);
  box-shadow: 0 10px 28px rgba(91,14,20,0.32);
}
.btn-demo {
  width:100%; padding:13px;
  background:transparent; color:#5B0E14;
  border:1.5px solid #5B0E14; border-radius:10px;
  font-size:14px; font-weight:600; font-family:'Cairo',sans-serif;
  cursor:pointer; transition:all .25s;
  display:flex; align-items:center; justify-content:center; gap:8px;
}
.btn-demo:hover { background:#5B0E14; color:#F1E194; }
.login-divider {
  display:flex; align-items:center; gap:10px;
  margin:16px 0; color:#b9a070; font-size:12px;
}
.login-divider::before,.login-divider::after {
  content:''; flex:1; height:1px; background:#E5D88A;
}
.login-footer {
  text-align:center; margin-top:24px; padding-top:16px;
  border-top:1px solid #E5D88A;
  font-size:12px; color:#b9a070; font-family:'Cairo',sans-serif;
}
.login-footer strong { color:#8B6219; }
.login-error {
  background:#fee2e2; color:#9b1c1c; border:1px solid #fca5a5;
  border-radius:8px; padding:10px 14px; font-size:13px;
  margin-bottom:14px; display:none; align-items:center; gap:8px;
}

/* ===== LOADER ===== */
.loader {
  position:fixed; inset:0; z-index:10000;
  background:rgba(15,3,4,0.9);
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
  gap:18px;
}
.loader.show { display:flex; }
.loader-ring {
  width:58px; height:58px;
  border:3px solid rgba(241,225,148,0.2);
  border-top-color:#F1E194;
  border-radius:50%; animation:spin .9s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }
.loader-msg {
  color:#F1E194; font-size:15px;
  font-family:'Cairo',sans-serif; font-weight:500;
}

/* ===== TOAST ===== */
.toast-wrap {
  position:fixed; top:80px; left:50%;
  transform:translateX(-50%); z-index:10001;
  display:flex; flex-direction:column; gap:8px; align-items:center;
}
.toast {
  background:var(--card); border-radius:12px;
  padding:14px 20px; min-width:260px; max-width:360px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.18);
  display:flex; align-items:center; gap:12px;
  opacity:0; transform:translateY(-20px) scale(.95);
  transition: all .35s cubic-bezier(.22,1,.36,1);
  pointer-events:none;
}
.toast.show { opacity:1; transform:none; pointer-events:auto; }
.toast-success { border-right:4px solid #10b981; }
.toast-error   { border-right:4px solid #ef4444; }
.toast-info    { border-right:4px solid #3b82f6; }
.toast-warning { border-right:4px solid #f59e0b; }
.toast i { font-size:20px; }
.toast-success i { color:#10b981; }
.toast-error   i { color:#ef4444; }
.toast-info    i { color:#3b82f6; }
.toast-warning i { color:#f59e0b; }
.toast span { font-family:'Cairo',sans-serif; font-size:14px; font-weight:500; color:var(--text); }

/* ===== CONFIRM DIALOG ===== */
.confirm-overlay {
  position:fixed; inset:0; z-index:5000;
  background:rgba(0,0,0,0.55); backdrop-filter:blur(4px);
  display:none; align-items:center; justify-content:center;
}
.confirm-overlay.show { display:flex; }
.confirm-card {
  background:var(--card); border-radius:18px;
  padding:36px 32px; max-width:380px; width:calc(100% - 40px);
  text-align:center; box-shadow:var(--shadow-lg);
  animation:confirmIn .3s cubic-bezier(.22,1,.36,1);
}
@keyframes confirmIn {
  from{opacity:0;transform:scale(.88)}
  to{opacity:1;transform:none}
}
.confirm-icon {
  width:64px; height:64px; margin:0 auto 16px;
  background:#fee2e2; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:28px; color:#ef4444;
}
.confirm-title {
  font-size:20px; font-weight:700;
  color:var(--text); margin-bottom:8px;
  font-family:'Cairo',sans-serif;
}
.confirm-msg {
  font-size:14px; color:var(--text-muted);
  margin-bottom:24px; line-height:1.6;
  font-family:'Cairo',sans-serif;
}
.confirm-student-name {
  font-weight:700; color:var(--primary);
  font-size:16px;
}
.confirm-btns {
  display:flex; gap:10px;
}
.confirm-btns button {
  flex:1; padding:13px;
  border-radius:10px; font-size:14px; font-weight:700;
  font-family:'Cairo',sans-serif; cursor:pointer; border:none;
  transition:all .2s;
}
.btn-cancel-confirm {
  background:var(--bg); color:var(--text-muted);
  border:1.5px solid var(--border) !important;
}
.btn-cancel-confirm:hover { background:var(--border); }
.btn-delete-confirm {
  background:#ef4444; color:white;
}
.btn-delete-confirm:hover {
  background:#dc2626;
  transform:translateY(-1px);
  box-shadow:0 6px 16px rgba(239,68,68,0.35);
}

/* ===== STATUS BADGE ===== */
.status-badge {
  display:flex; align-items:center; gap:7px;
  padding:7px 14px; border-radius:20px;
  background:var(--card); box-shadow:var(--shadow);
  font-size:12px; font-weight:600;
  font-family:'Cairo',sans-serif; color:var(--text-muted);
}
.status-dot {
  width:9px; height:9px; border-radius:50%;
  animation:pulse 2s ease infinite;
}
.status-dot.connected { background:#10b981; }
.status-dot.demo      { background:#f59e0b; }
@keyframes pulse {
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:.6;transform:scale(.85)}
}

/* ===== SIDEBAR ===== */
.sidebar {
  position:fixed; right:0; top:0; bottom:0;
  width:var(--sidebar-w);
  background:var(--card);
  border-left:1px solid var(--border);
  z-index:300;
  display:flex; flex-direction:column;
  box-shadow:var(--shadow);
  transition:width .3s cubic-bezier(.22,1,.36,1);
  overflow:hidden;
}
.sidebar:hover { width:240px; }
.sidebar-logo {
  height:var(--header-h); min-height:var(--header-h);
  display:flex; align-items:center; padding:0 21px;
  border-bottom:1px solid var(--border);
  gap:14px; overflow:hidden;
}
.sidebar-logo-icon {
  width:34px; height:34px; flex-shrink:0;
  background:linear-gradient(135deg,var(--primary),var(--primary-light));
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; color:var(--bg);
}
.sidebar-logo-text {
  font-weight:800; font-size:18px; color:var(--primary);
  white-space:nowrap; opacity:0; transition:opacity .25s .05s;
  font-family:'Cairo',sans-serif;
}
.sidebar:hover .sidebar-logo-text { opacity:1; }
.sidebar-nav { flex:1; padding:12px 0; overflow:hidden; }
.nav-item {
  display:flex; align-items:center; gap:14px;
  padding:13px 21px; cursor:pointer; white-space:nowrap;
  transition:all .2s; color:var(--text-muted);
  border-right:3px solid transparent;
  overflow:hidden;
}
.nav-item:hover { background:var(--bg); color:var(--primary); }
.nav-item.active {
  background:var(--bg); color:var(--primary);
  border-right-color:var(--primary);
  font-weight:700;
}
.nav-icon {
  width:30px; height:30px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; border-radius:8px;
}
.nav-item.active .nav-icon {
  background:var(--primary); color:var(--bg);
}
.nav-label {
  font-size:14px; font-weight:600;
  opacity:0; transition:opacity .2s .06s;
  font-family:'Cairo',sans-serif;
}
.sidebar:hover .nav-label { opacity:1; }

/* ===== HEADER ===== */
.app-header {
  position:fixed; top:0; right:var(--sidebar-w); left:0;
  height:var(--header-h);
  background:var(--card);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center;
  justify-content:space-between;
  padding:0 28px;
  z-index:200; box-shadow:var(--shadow);
  transition:right .3s;
}
.header-actions { display:flex; gap:10px; align-items:center; }
.header-right { display:flex; align-items:center; gap:14px; }
.user-chip {
  display:flex; align-items:center; gap:10px;
  padding:6px 14px 6px 6px;
  background:var(--bg); border-radius:24px;
  border:1px solid var(--border);
}
.user-avatar {
  width:34px; height:34px; border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--primary-light));
  display:flex; align-items:center; justify-content:center;
  font-size:14px; color:var(--bg); font-weight:700;
}
.user-name {
  font-size:13px; font-weight:600;
  color:var(--text); font-family:'Cairo',sans-serif;
}

/* ===== BTN STYLES ===== */
.btn {
  display:inline-flex; align-items:center; gap:7px;
  padding:10px 20px; border-radius:10px;
  font-size:13px; font-weight:700;
  font-family:'Cairo',sans-serif;
  cursor:pointer; border:none; transition:all .2s;
}
.btn-primary { background:var(--primary); color:var(--bg); }
.btn-primary:hover { transform:translateY(-2px); box-shadow:var(--shadow-lg); }
.btn-outline {
  background:transparent; color:var(--primary);
  border:2px solid var(--primary) !important;
}
.btn-outline:hover { background:var(--primary); color:var(--bg); }
.btn-outline.active {
  background:#f59e0b; border-color:#f59e0b !important; color:white;
}
.btn-success { background:#10b981; color:white; }
.btn-success:hover { background:#059669; transform:translateY(-1px); }
.btn-sm { padding:8px 14px; font-size:12px; }

/* ===== MAIN CONTENT ===== */
.main {
  margin-right:var(--sidebar-w);
  margin-top:var(--header-h);
  height:calc(100vh - var(--header-h));
  overflow-y:auto; padding:28px;
  transition:margin-right .3s;
}
.page { display:none; }
.page.active { display:block; }

/* ===== PAGE TITLE ===== */
.page-title {
  font-size:22px; font-weight:800;
  color:var(--text); margin-bottom:22px;
  font-family:'Cairo',sans-serif;
  display:flex; align-items:center; gap:10px;
}
.page-title i {
  width:40px; height:40px;
  background:linear-gradient(135deg,var(--primary),var(--primary-light));
  border-radius:10px; display:flex; align-items:center; justify-content:center;
  font-size:18px; color:var(--bg);
}
.section-title {
  font-size:16px; font-weight:700; color:var(--text);
  margin:28px 0 16px; display:flex; align-items:center; gap:8px;
  font-family:'Cairo',sans-serif;
}
.section-title i { color:var(--primary); font-size:16px; }

/* ===== STATS GRID ===== */
.stats-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:18px; margin-bottom:24px;
}
.stat-card {
  background:var(--card); border-radius:var(--radius);
  padding:22px; box-shadow:var(--shadow);
  border:1px solid var(--border);
  transition:all .25s; position:relative; overflow:hidden;
}
.stat-card::before {
  content:''; position:absolute; top:0; right:0; left:0; height:3px;
  background:linear-gradient(90deg,var(--primary),var(--accent));
}
.stat-card:hover { transform:translateY(-3px); box-shadow:var(--shadow-lg); }
.stat-row { display:flex; justify-content:space-between; align-items:flex-start; }
.stat-info {}
.stat-label {
  font-size:12px; font-weight:600; color:var(--text-muted);
  margin-bottom:6px; font-family:'Cairo',sans-serif;
}
.stat-val {
  font-size:28px; font-weight:800; color:var(--text);
  font-family:'Cairo',sans-serif; line-height:1;
}
.stat-sub {
  font-size:11px; color:var(--text-muted);
  margin-top:4px; font-family:'Cairo',sans-serif;
}
.stat-icon {
  width:46px; height:46px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; flex-shrink:0;
}
.icon-blue   { background:#dbeafe; color:#1d4ed8; }
.icon-green  { background:#d1fae5; color:#059669; }
.icon-yellow { background:#fef3c7; color:#d97706; }
.icon-purple { background:#ede9fe; color:#7c3aed; }
.icon-pink   { background:#fce7f3; color:#ec4899; }
.icon-red    { background:#fee2e2; color:#dc2626; }

.stat-card.warning-card {
  background:linear-gradient(135deg,#fff5f5,#fee2e2);
  border-color:#fca5a5;
}
.stat-card.warning-card .stat-val { color:#dc2626; }

/* ===== TABLE ===== */
.table-card {
  background:var(--card); border-radius:var(--radius);
  box-shadow:var(--shadow); border:1px solid var(--border); overflow:hidden;
}
.table-toolbar {
  padding:18px 22px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
}
.search-wrap {
  position:relative; flex:1; min-width:180px; max-width:340px;
}
.search-icon {
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  color:var(--text-muted); font-size:13px; pointer-events:none;
}
.search-inp {
  width:100%; padding:9px 36px 9px 12px;
  border:1.5px solid var(--border); border-radius:8px;
  background:var(--bg); color:var(--text);
  font-size:13px; font-family:'Cairo',sans-serif;
  transition:border .2s;
}
.search-inp:focus { outline:none; border-color:var(--primary); }
.table-scroll {
  overflow-x:auto;
  max-height:calc(100vh - var(--header-h) - 220px);
}
table { width:100%; border-collapse:collapse; }
thead { background:var(--bg); position:sticky; top:0; z-index:5; }
th {
  padding:12px 14px; text-align:right;
  font-size:12px; font-weight:700; color:var(--text-muted);
  border-bottom:2px solid var(--border); white-space:nowrap;
  font-family:'Cairo',sans-serif;
}
td {
  padding:13px 14px; border-bottom:1px solid var(--border);
  font-size:13px; color:var(--text); font-family:'Cairo',sans-serif;
}
tbody tr:hover { background:var(--bg); }
.td-actions { display:flex; gap:6px; }
.act-btn {
  width:30px; height:30px; border:none; border-radius:7px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:13px; transition:all .2s;
}
.act-edit { background:#dbeafe; color:#1d4ed8; }
.act-edit:hover { background:#1d4ed8; color:white; }
.act-del  { background:#fee2e2; color:#dc2626; }
.act-del:hover  { background:#dc2626; color:white; }

/* ===== MODAL ===== */
.modal {
  position:fixed; inset:0; z-index:1000;
  background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);
  display:none; align-items:center; justify-content:center;
  padding:20px;
}
.modal.show { display:flex; }
.modal-box {
  background:var(--card); border-radius:18px;
  width:100%; max-width:680px; max-height:90vh;
  overflow-y:auto; box-shadow:var(--shadow-lg);
  animation:modalIn .3s cubic-bezier(.22,1,.36,1);
}
@keyframes modalIn {
  from{opacity:0;transform:scale(.93)}
  to{opacity:1;transform:none}
}
.modal-head {
  padding:22px 26px; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
  position:sticky; top:0; background:var(--card); z-index:5;
}
.modal-head h3 {
  font-size:18px; font-weight:700; color:var(--text);
  font-family:'Cairo',sans-serif;
}
.modal-close {
  width:34px; height:34px; border:none; border-radius:8px;
  background:var(--bg); color:var(--text-muted);
  cursor:pointer; font-size:16px;
  display:flex; align-items:center; justify-content:center;
  transition:all .2s;
}
.modal-close:hover { background:var(--border); color:var(--text); }
.modal-body { padding:22px 26px; }
.modal-foot {
  padding:16px 26px; border-top:1px solid var(--border);
  display:flex; justify-content:flex-end; gap:10px;
  position:sticky; bottom:0; background:var(--card);
}
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr)); gap:18px; }
.form-full { grid-column:1/-1; }
.fg { display:flex; flex-direction:column; gap:7px; }
.fg label {
  font-size:13px; font-weight:700; color:var(--text);
  font-family:'Cairo',sans-serif;
}
.fg label .req { color:#ef4444; }
.fg input, .fg select {
  padding:11px 13px; border:1.5px solid var(--border);
  border-radius:9px; font-size:13px;
  font-family:'Cairo',sans-serif;
  background:var(--bg); color:var(--text);
  transition:border .2s;
}
.fg input:focus, .fg select:focus {
  outline:none; border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(91,14,20,0.08);
}
.fg input.calc {
  background:var(--card); color:var(--text-muted);
  font-weight:700; border-style:dashed;
}
.calc-hint {
  font-size:11px; color:var(--text-muted);
  font-family:'Cairo',sans-serif; margin-top:2px;
}

/* ===== FILTER MODAL ===== */
.filter-section-title {
  font-size:13px; font-weight:700; color:var(--text);
  margin-bottom:8px; font-family:'Cairo',sans-serif;
}
.chip-group { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
.chip {
  padding:7px 16px; border-radius:20px; font-size:12px; font-weight:600;
  border:1.5px solid var(--border); background:var(--card); color:var(--text-muted);
  cursor:pointer; transition:all .2s; font-family:'Cairo',sans-serif;
}
.chip:hover { border-color:var(--primary); color:var(--primary); }
.chip.on { background:var(--primary); color:var(--bg); border-color:var(--primary); }

/* ===== CHARTS ===== */
.charts-grid {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(420px,1fr));
  gap:22px; margin-top:24px;
}
.chart-box {
  background:var(--card); border-radius:var(--radius);
  padding:22px; box-shadow:var(--shadow); border:1px solid var(--border);
}
.chart-box h4 {
  font-size:14px; font-weight:700; color:var(--text);
  margin-bottom:18px; font-family:'Cairo',sans-serif;
  display:flex; align-items:center; gap:7px;
}
.chart-box h4 i { color:var(--primary); }
.chart-wrap { position:relative; height:280px; }

/* ===== MINI TABLE ===== */
.mini-table-wrap {
  background:var(--card); border-radius:var(--radius);
  box-shadow:var(--shadow); border:1px solid var(--border);
  margin-top:22px; overflow:hidden;
}
.mini-table-head {
  padding:16px 22px; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center; gap:14px;
}
.mini-table-head h4 {
  font-size:15px; font-weight:700; color:var(--text);
  font-family:'Cairo',sans-serif;
}

/* ===== SETTINGS ===== */
.settings-section {
  background:var(--card); border-radius:var(--radius);
  padding:24px; box-shadow:var(--shadow); border:1px solid var(--border);
  margin-bottom:20px;
}
.settings-section h3 {
  font-size:16px; font-weight:700; color:var(--text);
  margin-bottom:20px; font-family:'Cairo',sans-serif;
  display:flex; align-items:center; gap:8px;
}
.settings-section h3 i { color:var(--primary); }
.toggle-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:13px 0; border-bottom:1px solid var(--border);
}
.toggle-row:last-child { border-bottom:none; }
.toggle-info {}
.toggle-info .t-label {
  font-size:14px; font-weight:600; color:var(--text);
  font-family:'Cairo',sans-serif;
}
.toggle-info .t-desc {
  font-size:12px; color:var(--text-muted); margin-top:2px;
  font-family:'Cairo',sans-serif;
}
.toggle {
  width:48px; height:26px; background:var(--border);
  border-radius:13px; cursor:pointer; position:relative; transition:.3s;
  flex-shrink:0;
}
.toggle.on { background:var(--primary); }
.toggle::after {
  content:''; position:absolute; top:3px; right:3px;
  width:20px; height:20px; background:white;
  border-radius:50%; transition:.3s;
}
.toggle.on::after { right:25px; }
.alert-box {
  padding:11px 14px; border-radius:9px;
  display:flex; align-items:center; gap:10px;
  font-size:13px; font-family:'Cairo',sans-serif; margin-top:14px;
}
.alert-info { background:#dbeafe; color:#1e40af; border:1px solid #93c5fd; }
.alert-warn { background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
.alert-success { background:#d1fae5; color:#065f46; border:1px solid #6ee7b7; }

/* ===== PROFILE SETTINGS ===== */
.profile-header {
  display:flex; align-items:center; gap:18px; margin-bottom:20px;
}
.profile-avatar-big {
  width:72px; height:72px; border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--primary-light));
  display:flex; align-items:center; justify-content:center;
  font-size:28px; color:var(--bg); flex-shrink:0;
}
.profile-info .p-name {
  font-size:16px; font-weight:700; color:var(--text);
  font-family:'Cairo',sans-serif;
}
.profile-info .p-email {
  font-size:13px; color:var(--text-muted);
  font-family:'Cairo',sans-serif; margin-top:2px;
}
.profile-status {
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 12px; border-radius:12px;
  font-size:11px; font-weight:600; margin-top:6px;
  font-family:'Cairo',sans-serif;
}
.profile-status.demo { background:#fef3c7; color:#92400e; }
.profile-status.live { background:#d1fae5; color:#065f46; }

/* ===== EMPTY STATE ===== */
.empty-row td {
  text-align:center; padding:50px 20px;
}
.empty-state {
  display:flex; flex-direction:column; align-items:center;
  gap:10px; color:var(--text-muted);
}
.empty-state i { font-size:46px; opacity:.25; }
.empty-state p { font-size:14px; font-family:'Cairo',sans-serif; }

/* ===== MOBILE ===== */
@media(max-width:768px) {
  body { overflow:hidden; }
  .sidebar { display:none !important; }
  .app-header {
    right:0; background:transparent;
    border-bottom:none; box-shadow:none;
    padding:0 16px;
  }
  .header-actions .btn span { display:none; }
  .header-right .status-badge span:last-child { display:none; }
  .main {
    margin-right:0;
    margin-top:0;
    height:calc(100vh - 70px);
    padding:16px 14px 80px;
    padding-top:80px;
  }
  /* Mobile fab buttons */
  .mobile-fab-bar {
    position:fixed; top:12px; right:0; left:0;
    display:flex; justify-content:center; gap:14px;
    z-index:250; pointer-events:none;
  }
  .fab-btn {
    width:46px; height:46px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:18px; border:none; cursor:pointer;
    box-shadow:0 4px 14px rgba(0,0,0,0.2);
    pointer-events:auto; transition:all .2s;
  }
  .fab-btn:active { transform:scale(.93); }
  .fab-add  { background:var(--primary); color:var(--bg); }
  .fab-filter{ background:white; color:var(--primary); border:2px solid var(--primary); }
  .fab-filter.active { background:#f59e0b; border-color:#f59e0b; color:white; }
  .fab-export{ background:#10b981; color:white; }
  /* Mobile bottom nav */
  .bottom-nav {
    position:fixed; bottom:0; right:0; left:0;
    height:68px; background:var(--card);
    border-top:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-around;
    z-index:300; box-shadow:0 -4px 18px rgba(0,0,0,0.1);
    border-radius:20px 20px 0 0;
    padding:0 8px;
  }
  .nav-tab {
    flex:1; display:flex; flex-direction:column;
    align-items:center; gap:3px; cursor:pointer;
    padding:8px 4px; border-radius:14px; transition:all .25s;
    position:relative;
  }
  .nav-tab i { font-size:20px; color:var(--text-muted); transition:all .25s; }
  .nav-tab span {
    font-size:10px; font-weight:600; color:var(--text-muted);
    font-family:'Cairo',sans-serif; transition:all .25s;
  }
  .nav-tab.active i { color:var(--primary); }
  .nav-tab.active span { color:var(--primary); font-weight:800; }
  .nav-tab.active::before {
    content:''; position:absolute; top:4px;
    width:28px; height:28px; border-radius:10px;
    background:var(--bg); z-index:-1;
  }
  .nav-tab-dot {
    position:absolute; top:6px;
    width:24px; height:3px; border-radius:2px;
    background:var(--primary); opacity:0; transition:opacity .2s;
    top:2px;
  }
  .nav-tab.active .nav-tab-dot { opacity:1; }
  /* Desktop elements hide on mobile */
  .app-header .header-actions .btn-primary,
  .app-header .header-actions .btn-outline,
  .app-header .header-actions .btn-success { display:none; }
  .app-header .status-badge { display:none; }
  /* Stats on mobile */
  .stats-grid { grid-template-columns:1fr 1fr; gap:12px; }
  .stat-val { font-size:20px; }
  .stat-icon { width:38px; height:38px; font-size:16px; }
  /* Charts on mobile */
  .charts-grid { grid-template-columns:1fr; gap:16px; }
  /* Table on mobile */
  .table-scroll { max-height:calc(100vh - 230px); }
  /* Form on mobile */
  .form-grid { grid-template-columns:1fr; }
  .modal-box { border-radius:18px; max-height:95vh; }
  /* Settings mobile */
  .profile-header { flex-direction:column; text-align:center; }
}
@media(min-width:769px) {
  .mobile-fab-bar, .bottom-nav { display:none !important; }
}
@media(max-width:480px) {
  .stats-grid { grid-template-columns:1fr; }
  .stat-card { padding:16px; }
  .user-chip{display: none;}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <div class="login-brand">
      <div class="login-logo-wrap">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div class="login-title">SPMS</div>
      <div class="login-sub">نظام إدارة الطلاب والأرباح</div>
    </div>
    <div id="loginError" class="login-error">
      <i class="fas fa-exclamation-circle"></i>
      <span id="loginErrorMsg">بيانات غير صحيحة</span>
    </div>
    <form id="loginForm" autocomplete="off">
      <div class="login-field">
        <i class="fas fa-envelope login-field-icon"></i>
        <input type="email" class="login-input" id="loginEmail" placeholder="البريد الإلكتروني" autocomplete="email">
      </div>
      <div class="login-field">
        <i class="fas fa-lock login-field-icon"></i>
        <input type="password" class="login-input" id="loginPassword" placeholder="كلمة المرور" autocomplete="current-password">
      </div>
      <button type="submit" class="btn-login">
        <i class="fas fa-sign-in-alt"></i>
        تسجيل الدخول عبر Firebase
      </button>
    </form>
    <div class="login-divider">أو</div>
    <button class="btn-demo" onclick="loginDemo()">
      <i class="fas fa-flask"></i>
      الدخول بدون تسجيل — وضع تجريبي
    </button>
    <div class="login-footer">
      <i class="fas fa-shield-halved"></i>
      بياناتك محمية ومشفرة
      <br><br>
      <strong>Motjari</strong> &copy; 2024 — SPMS v2.0
    </div>
  </div>
</div>

<!-- LOADER -->
<div id="loader" class="loader">
  <div class="loader-ring"></div>
  <div class="loader-msg" id="loaderMsg">جاري التحميل...</div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- CONFIRM DIALOG -->
<div id="confirmOverlay" class="confirm-overlay">
  <div class="confirm-card">
    <div class="confirm-icon">
      <i class="fas fa-trash-alt"></i>
    </div>
    <div class="confirm-title">تأكيد الحذف</div>
    <div class="confirm-msg">
      هل أنت متأكد من حذف بيانات الطالب<br>
      <span class="confirm-student-name" id="confirmStudentName"></span>؟<br>
      <small>لا يمكن التراجع عن هذا الإجراء</small>
    </div>
    <div class="confirm-btns">
      <button class="btn-cancel-confirm" onclick="closeConfirm()">
        <i class="fas fa-times"></i> إلغاء
      </button>
      <button class="btn-delete-confirm" id="confirmDeleteBtn">
        <i class="fas fa-trash"></i> حذف نهائياً
      </button>
    </div>
  </div>
</div>

<!-- APP CONTAINER -->
<div id="appWrap" style="display:none">

  <!-- SIDEBAR (desktop) -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon"><i class="fas fa-graduation-cap"></i></div>
      <div class="sidebar-logo-text">SPMS</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active" data-page="home">
        <div class="nav-icon"><i class="fas fa-house"></i></div>
        <span class="nav-label">الرئيسية</span>
      </div>
      <div class="nav-item" data-page="students">
        <div class="nav-icon"><i class="fas fa-table-list"></i></div>
        <span class="nav-label">جدول الطلاب</span>
      </div>
      <div class="nav-item" data-page="analytics">
        <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
        <span class="nav-label">التحليلات</span>
      </div>
      <div class="nav-item" data-page="settings">
        <div class="nav-icon"><i class="fas fa-gear"></i></div>
        <span class="nav-label">الإعدادات</span>
      </div>
    </div>
  </nav>

  <!-- HEADER (desktop) -->
  <header class="app-header">
    <div class="header-actions">
      <button class="btn btn-primary" onclick="openStudentModal()">
        <i class="fas fa-user-plus"></i><span>إضافة طالب</span>
      </button>
      <button class="btn btn-outline" id="filterBtn" onclick="openFilterModal()">
        <i class="fas fa-sliders"></i><span>فلترة متقدمة</span>
      </button>
      <button class="btn btn-success" onclick="exportCSV()">
        <i class="fas fa-file-excel"></i><span>تصدير Excel</span>
      </button>
    </div>
    <div class="header-right">
      <div class="status-badge">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusTxt">وضع تجريبي</span>
      </div>
      <div class="user-chip">
        <div class="user-name" id="userNameTxt">مستخدم</div>
        <div class="user-avatar"><i class="fas fa-user"></i></div>
      </div>
    </div>
  </header>

  <!-- MOBILE FAB BAR -->
  <div class="mobile-fab-bar">
    <button class="fab-btn fab-add" onclick="openStudentModal()"><i class="fas fa-plus"></i></button>
    <button class="fab-btn fab-filter" id="mFabFilter" onclick="openFilterModal()"><i class="fas fa-sliders"></i></button>
    <button class="fab-btn fab-export" onclick="exportCSV()"><i class="fas fa-file-excel"></i></button>
  </div>

  <!-- MAIN -->
  <main class="main" id="mainScroll">

    <!-- HOME PAGE -->
    <section id="home" class="page active">
      <div class="page-title">
        <i class="fas fa-house"></i>
        لوحة التحكم الرئيسية
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">إجمالي الطلاب</div>
              <div class="stat-val" id="h_students">0</div>
              <div class="stat-sub">طالب مسجل</div>
            </div>
            <div class="stat-icon icon-blue"><i class="fas fa-users"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">إجمالي المبيعات</div>
              <div class="stat-val" id="h_sales">0</div>
              <div class="stat-sub">دينار عراقي</div>
            </div>
            <div class="stat-icon icon-green"><i class="fas fa-money-bill-trend-up"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">صافي الأرباح</div>
              <div class="stat-val" id="h_net">0</div>
              <div class="stat-sub">دينار عراقي</div>
            </div>
            <div class="stat-icon icon-yellow"><i class="fas fa-chart-line"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">أرباح المدرسين</div>
              <div class="stat-val" id="h_teacher">0</div>
            </div>
            <div class="stat-icon icon-purple"><i class="fas fa-chalkboard-user"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">أرباح المنصة</div>
              <div class="stat-val" id="h_platform">0</div>
            </div>
            <div class="stat-icon icon-pink"><i class="fas fa-desktop"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">أرباح الإدارة</div>
              <div class="stat-val" id="h_admin">0</div>
            </div>
            <div class="stat-icon icon-red"><i class="fas fa-briefcase"></i></div>
          </div>
        </div>
      </div>
      <div class="mini-table-wrap">
        <div class="mini-table-head">
          <h4><i class="fas fa-clock-rotate-left" style="color:var(--primary)"></i> آخر 20 طالب مضاف</h4>
          <div class="search-wrap" style="max-width:240px">
            <i class="fas fa-magnifying-glass search-icon"></i>
            <input type="text" class="search-inp" id="quickSearchInp" placeholder="بحث سريع..." oninput="quickSearch()">
          </div>
        </div>
        <div class="table-scroll" style="max-height:380px">
          <table>
            <thead><tr>
              <th>الاسم</th><th>المادة</th><th>المدرس</th>
              <th>التاريخ</th><th>الصافي</th>
            </tr></thead>
            <tbody id="miniTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- STUDENTS TABLE PAGE -->
    <section id="students" class="page">
      <div class="page-title">
        <i class="fas fa-table-list"></i>
        جدول الطلاب
      </div>
      <div class="table-card">
        <div class="table-toolbar">
          <div class="search-wrap">
            <i class="fas fa-magnifying-glass search-icon"></i>
            <input type="text" class="search-inp" id="tableSearchInp" placeholder="بحث بالاسم..." oninput="searchTable()">
          </div>
          <span id="tableCount" style="font-size:13px;color:var(--text-muted);font-family:'Cairo',sans-serif;font-weight:600"></span>
        </div>
        <div class="table-scroll">
          <table>
            <thead><tr>
              <th>#</th><th>الاسم الثلاثي</th><th>المحافظة</th>
              <th>التاريخ</th><th>المادة</th><th>المدرس</th>
              <th>المنصة</th><th>المكتبة</th><th>كود الاشتراك</th>
              <th>كورس 1</th><th>كورس 2</th><th>صرفيات</th>
              <th>الصافي</th><th>ربح المدرس</th>
              <th>ربح المنصة</th><th>ربح الإدارة</th>
              <th>تحكم</th>
            </tr></thead>
            <tbody id="mainTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS PAGE -->
    <section id="analytics" class="page">
      <div class="page-title">
        <i class="fas fa-chart-pie"></i>
        لوحة التحليلات
      </div>

      <div class="section-title"><i class="fas fa-gauge-high"></i> مؤشرات الأداء الرئيسية</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">إجمالي الطلاب</div>
              <div class="stat-val" id="a_students">0</div>
            </div>
            <div class="stat-icon icon-blue"><i class="fas fa-users"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">إجمالي المبيعات</div>
              <div class="stat-val" id="a_sales">0</div>
            </div>
            <div class="stat-icon icon-green"><i class="fas fa-coins"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">صافي الأرباح</div>
              <div class="stat-val" id="a_net">0</div>
            </div>
            <div class="stat-icon icon-yellow"><i class="fas fa-chart-line"></i></div>
          </div>
        </div>
      </div>

      <div class="section-title"><i class="fas fa-circle-dollar-to-slot"></i> توزيع الأرباح</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">أرباح المدرسين</div>
              <div class="stat-val" id="a_teacher">0</div>
            </div>
            <div class="stat-icon icon-purple"><i class="fas fa-chalkboard-user"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">أرباح المنصة</div>
              <div class="stat-val" id="a_platform">0</div>
            </div>
            <div class="stat-icon icon-pink"><i class="fas fa-desktop"></i></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-row">
            <div class="stat-info">
              <div class="stat-label">أرباح الإدارة</div>
              <div class="stat-val" id="a_admin">0</div>
            </div>
            <div class="stat-icon icon-red"><i class="fas fa-briefcase"></i></div>
          </div>
        </div>
      </div>

      <div class="section-title"><i class="fas fa-trophy"></i> التصنيفات</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-medal" style="color:var(--primary)"></i> أعلى مدرس ربحاً</div>
          <div class="stat-val" id="a_topTeacher" style="font-size:18px;margin-top:6px">—</div>
          <div class="stat-sub" id="a_topTeacherVal"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-trophy" style="color:var(--primary)"></i> أكثر منصة مبيعاً</div>
          <div class="stat-val" id="a_topPlatform" style="font-size:18px;margin-top:6px">—</div>
          <div class="stat-sub" id="a_topPlatformVal"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-book-open" style="color:var(--primary)"></i> المادة الأكثر طلباً</div>
          <div class="stat-val" id="a_topSubject" style="font-size:18px;margin-top:6px">—</div>
          <div class="stat-sub" id="a_topSubjectVal"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-location-dot" style="color:var(--primary)"></i> أعلى محافظة نشاطاً</div>
          <div class="stat-val" id="a_topProv" style="font-size:18px;margin-top:6px">—</div>
          <div class="stat-sub" id="a_topProvVal"></div>
        </div>
      </div>

      <div class="section-title"><i class="fas fa-arrow-trend-up"></i> مؤشرات الأداء</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-divide" style="color:var(--primary)"></i> متوسط الربح للطالب</div>
          <div class="stat-val" id="a_avg" style="margin-top:6px">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-percent" style="color:var(--primary)"></i> نسبة الصرفيات</div>
          <div class="stat-val" id="a_expRatio" style="margin-top:6px">0%</div>
        </div>
      </div>

      <div class="section-title"><i class="fas fa-chart-column"></i> الرسوم البيانية</div>
      <div class="charts-grid">
        <div class="chart-box">
          <h4><i class="fas fa-chart-pie"></i> توزيع الأرباح</h4>
          <div class="chart-wrap"><canvas id="cPie"></canvas></div>
        </div>
        <div class="chart-box">
          <h4><i class="fas fa-chart-line"></i> الأرباح الشهرية</h4>
          <div class="chart-wrap"><canvas id="cLine"></canvas></div>
        </div>
        <div class="chart-box">
          <h4><i class="fas fa-ranking-star"></i> أعلى 10 مدرسين ربحاً</h4>
          <div class="chart-wrap"><canvas id="cTeachers"></canvas></div>
        </div>
        <div class="chart-box">
          <h4><i class="fas fa-desktop"></i> أعلى 10 منصات مبيعاً</h4>
          <div class="chart-wrap"><canvas id="cPlatforms"></canvas></div>
        </div>
        <div class="chart-box">
          <h4><i class="fas fa-book"></i> أعلى 5 مواد طلباً</h4>
          <div class="chart-wrap"><canvas id="cSubjects"></canvas></div>
        </div>
        <div class="chart-box">
          <h4><i class="fas fa-map-location-dot"></i> أعلى 5 محافظات تسجيلاً</h4>
          <div class="chart-wrap"><canvas id="cProvinces"></canvas></div>
        </div>
      </div>

      <div class="section-title"><i class="fas fa-triangle-exclamation"></i> تحذيرات ذكية</div>
      <div class="stats-grid">
        <div class="stat-card warning-card">
          <div class="stat-label"><i class="fas fa-circle-exclamation" style="color:#dc2626"></i> طلاب بخسارة</div>
          <div class="stat-val" id="a_loss" style="margin-top:6px">0</div>
          <div class="stat-sub">طالب بربح سلبي أو صفر</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-moon" style="color:var(--primary)"></i> منصات ضعيفة الأداء</div>
          <div class="stat-val" id="a_weakPlat" style="margin-top:6px">0</div>
          <div class="stat-sub">أقل من 5 طلاب</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-arrow-down" style="color:var(--primary)"></i> مدرسون قليلو الإنتاج</div>
          <div class="stat-val" id="a_lowTeach" style="margin-top:6px">0</div>
          <div class="stat-sub">أقل من 10,000 دينار</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS PAGE -->
    <section id="settings" class="page">
      <div class="page-title">
        <i class="fas fa-gear"></i>
        الإعدادات
      </div>

      <!-- Profile Card -->
      <div class="settings-section">
        <h3><i class="fas fa-circle-user"></i> ملف المستخدم</h3>
        <div class="profile-header">
          <div class="profile-avatar-big" id="profileAvatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="profile-info">
            <div class="p-name" id="profileName">مستخدم تجريبي</div>
            <div class="p-email" id="profileEmail">—</div>
            <div class="profile-status demo" id="profileStatus">
              <i class="fas fa-flask"></i> وضع تجريبي
            </div>
          </div>
        </div>
      </div>

      <!-- Profit Settings -->
      <div class="settings-section">
        <h3><i class="fas fa-sliders"></i> نسب توزيع الأرباح</h3>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:18px;font-family:'Cairo',sans-serif">
          تُطبَّق هذه النسب تلقائياً على كل طالب جديد
        </p>
        <div class="form-grid">
          <div class="fg">
            <label>نسبة ربح المدرس (%)</label>
            <input type="number" id="s_teacher" min="0" max="100" value="50">
          </div>
          <div class="fg">
            <label>نسبة ربح المنصة (%)</label>
            <input type="number" id="s_platform" min="0" max="100" value="25">
          </div>
          <div class="fg">
            <label>نسبة ربح الإدارة (%)</label>
            <input type="number" id="s_admin" min="0" max="100" value="25">
          </div>
        </div>
        <div class="alert-box alert-info" style="margin-top:14px">
          <i class="fas fa-circle-info"></i>
          <span>مجموع النسب يجب أن يساوي 100%</span>
        </div>
        <button class="btn btn-primary" style="margin-top:16px" onclick="saveProfitSettings()">
          <i class="fas fa-floppy-disk"></i> حفظ النسب
        </button>
      </div>

      <!-- Appearance -->
      <div class="settings-section">
        <h3><i class="fas fa-palette"></i> المظهر</h3>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="t-label">الوضع الداكن</div>
            <div class="t-desc">تفعيل المظهر الداكن للتطبيق</div>
          </div>
          <div class="toggle" id="themeToggle" onclick="toggleTheme()"></div>
        </div>
      </div>

      <!-- Connection -->
      <div class="settings-section">
        <h3><i class="fas fa-cloud"></i> الاتصال بـ Firebase</h3>
        <div class="toggle-row">
          <div class="toggle-info">
            <div class="t-label">ربط مع Firebase</div>
            <div class="t-desc">مزامنة البيانات مع السحابة</div>
          </div>
          <div class="toggle" id="fbToggle" onclick="toggleFirebase()"></div>
        </div>
        <div class="alert-box alert-warn" id="fbStatus" style="margin-top:14px">
          <i class="fas fa-triangle-exclamation"></i>
          <span>أنت في الوضع التجريبي — سجّل الدخول للربط بـ Firebase</span>
        </div>
      </div>

      <!-- System Info -->
      <div class="settings-section">
        <h3><i class="fas fa-building"></i> معلومات النظام</h3>
        <div class="fg">
          <label>اسم الجهة أو المركز</label>
          <input type="text" id="s_orgName" value="مركز التعليم">
        </div>
        <button class="btn btn-primary" style="margin-top:14px" onclick="saveOrgSettings()">
          <i class="fas fa-floppy-disk"></i> حفظ
        </button>
      </div>

      <!-- Export -->
      <div class="settings-section">
        <h3><i class="fas fa-file-export"></i> تصدير البيانات</h3>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;font-family:'Cairo',sans-serif">
          يتم تصدير البيانات المفلترة حالياً فقط بصيغة CSV متوافقة مع Excel
        </p>
        <button class="btn btn-success" onclick="exportCSV()">
          <i class="fas fa-file-excel"></i> تصدير إلى Excel
        </button>
      </div>
    </section>

  </main>

  <!-- MOBILE BOTTOM NAV -->
  <nav class="bottom-nav" id="bottomNav">
    <div class="nav-tab active" data-page="home">
      <div class="nav-tab-dot"></div>
      <i class="fas fa-house"></i>
      <span>الرئيسية</span>
    </div>
    <div class="nav-tab" data-page="students">
      <div class="nav-tab-dot"></div>
      <i class="fas fa-table-list"></i>
      <span>الجدول</span>
    </div>
    <div class="nav-tab" data-page="analytics">
      <div class="nav-tab-dot"></div>
      <i class="fas fa-chart-pie"></i>
      <span>التحليلات</span>
    </div>
    <div class="nav-tab" data-page="settings">
      <div class="nav-tab-dot"></div>
      <i class="fas fa-gear"></i>
      <span>الإعدادات</span>
    </div>
  </nav>

</div><!-- /appWrap -->

<!-- STUDENT MODAL -->
<div id="studentModal" class="modal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="modalHeadTitle">إضافة طالب جديد</h3>
      <button class="modal-close" onclick="closeStudentModal()"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="fg form-full">
          <label>الاسم الثلاثي <span class="req">*</span></label>
          <input type="text" id="f_name">
        </div>
        <div class="fg">
          <label>المحافظة</label>
          <input type="text" id="f_prov">
        </div>
        <div class="fg">
          <label>تاريخ التسجيل</label>
          <input type="date" id="f_date">
        </div>
        <div class="fg">
          <label>اسم المادة <span class="req">*</span></label>
          <input type="text" id="f_subj">
        </div>
        <div class="fg">
          <label>اسم المدرس</label>
          <input type="text" id="f_teacher">
        </div>
        <div class="fg">
          <label>اسم المنصة</label>
          <input type="text" id="f_platform">
        </div>
        <div class="fg">
          <label>اسم المكتبة</label>
          <input type="text" id="f_library">
        </div>
        <div class="fg">
          <label>كود الاشتراك <span class="req">*</span></label>
          <input type="text" id="f_code">
        </div>
        <div class="fg">
          <label>سعر الكورس الأول <span class="req">*</span></label>
          <input type="number" id="f_c1" value="0" oninput="calcProfits()">
        </div>
        <div class="fg">
          <label>سعر الكورس الثاني <span class="req">*</span></label>
          <input type="number" id="f_c2" value="0" oninput="calcProfits()">
        </div>
        <div class="fg">
          <label>صرفيات أخرى</label>
          <input type="number" id="f_exp" value="0" oninput="calcProfits()">
        </div>
        <div class="fg">
          <label>المجموع الصافي</label>
          <input type="number" id="f_net" class="calc" readonly>
          <div class="calc-hint"><i class="fas fa-calculator"></i> يُحسب تلقائياً</div>
        </div>
        <div class="fg">
          <label>ربح المدرس</label>
          <input type="number" id="f_tProfit" class="calc" readonly>
          <div class="calc-hint" id="tPctHint"></div>
        </div>
        <div class="fg">
          <label>ربح المنصة</label>
          <input type="number" id="f_pProfit" class="calc" readonly>
          <div class="calc-hint" id="pPctHint"></div>
        </div>
        <div class="fg">
          <label>ربح الإدارة</label>
          <input type="number" id="f_aProfit" class="calc" readonly>
          <div class="calc-hint" id="aPctHint"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline btn-sm" onclick="closeStudentModal()">إلغاء</button>
      <button class="btn btn-primary btn-sm" onclick="saveStudent()">
        <i class="fas fa-floppy-disk"></i> حفظ
      </button>
    </div>
  </div>
</div>

<!-- FILTER MODAL -->
<div id="filterModal" class="modal">
  <div class="modal-box">
    <div class="modal-head">
      <h3><i class="fas fa-sliders" style="color:var(--primary);margin-left:8px"></i> فلترة متقدمة شاملة</h3>
      <button class="modal-close" onclick="closeFilterModal()"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="alert-box alert-info" style="margin-bottom:20px">
        <i class="fas fa-circle-info"></i>
        <span>تؤثر هذه الفلترة على جميع الجداول والبطاقات والرسوم البيانية</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
        <div class="fg">
          <label class="filter-section-title">المدرس</label>
          <input type="text" class="search-inp" id="fl_teacher" placeholder="اسم المدرس...">
        </div>
        <div class="fg">
          <label class="filter-section-title">المنصة</label>
          <input type="text" class="search-inp" id="fl_platform" placeholder="اسم المنصة...">
        </div>
        <div class="fg">
          <label class="filter-section-title">المادة</label>
          <input type="text" class="search-inp" id="fl_subj" placeholder="اسم المادة...">
        </div>
        <div class="fg">
          <label class="filter-section-title">المحافظة</label>
          <input type="text" class="search-inp" id="fl_prov" placeholder="المحافظة...">
        </div>
      </div>
      <div style="margin-bottom:20px">
        <div class="filter-section-title"><i class="fas fa-calendar-days" style="color:var(--primary)"></i> الفترة الزمنية</div>
        <div class="chip-group">
          <div class="chip on" data-p="all">الكل</div>
          <div class="chip" data-p="today">اليوم</div>
          <div class="chip" data-p="week">آخر أسبوع</div>
          <div class="chip" data-p="month">آخر شهر</div>
          <div class="chip" data-p="custom">فترة مخصصة</div>
        </div>
      </div>
      <div id="customDateBox" style="display:none;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
        <div class="fg">
          <label>من تاريخ</label>
          <input type="date" class="search-inp" id="fl_from" style="width:100%">
        </div>
        <div class="fg">
          <label>إلى تاريخ</label>
          <input type="date" class="search-inp" id="fl_to" style="width:100%">
        </div>
      </div>
      <div>
        <div class="filter-section-title"><i class="fas fa-percent" style="color:var(--primary)"></i> فلترة حسب نسب الأرباح</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="fg">
            <label>نسبة المدرس</label>
            <input type="number" class="search-inp" id="fl_tPct" min="0" max="100" placeholder="أي" style="width:100%">
          </div>
          <div class="fg">
            <label>نسبة المنصة</label>
            <input type="number" class="search-inp" id="fl_pPct" min="0" max="100" placeholder="أي" style="width:100%">
          </div>
          <div class="fg">
            <label>نسبة الإدارة</label>
            <input type="number" class="search-inp" id="fl_aPct" min="0" max="100" placeholder="أي" style="width:100%">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline btn-sm" onclick="clearFilters()">
        <i class="fas fa-eraser"></i> مسح الفلاتر
      </button>
      <button class="btn btn-primary btn-sm" onclick="applyFilters()">
        <i class="fas fa-check"></i> تطبيق
      </button>
    </div>
  </div>
</div>

<script>
// ===========================
// CONFIG
// ===========================
const FIREBASE_CONFIG = {
        apiKey: "AIzaSyApd6DsoVLUW20MqcDlE4Uq7oqLOQgV4bo",
        authDomain: "spms-app-web.firebaseapp.com",
        projectId: "spms-app-web",
        storageBucket: "spms-app-web.firebasestorage.app",
        messagingSenderId: "818905832050",
        appId: "1:818905832050:web:90a5e79811ee02011240eb",
        measurementId: "G-4VTQKVR729"
      };

// ===========================
// STATE
// ===========================
const S = {
  students: [],
  editId: null,
  isDemoMode: true,
  isConnected: false,
  currentUser: null,
  db: null, auth: null,
  charts: {},
  filters: {
    teacher:'', platform:'', subject:'', province:'',
    period:'all', from:'', to:'',
    tPct:null, pPct:null, aPct:null
  },
  profits: { teacher:50, platform:25, admin:25 }
};

// ===========================
// INIT
// ===========================
document.addEventListener('DOMContentLoaded', ()=>{
  loadSettings();
  setupLogin();
  setupNavigation();
  setupFilterChips();
  restoreTheme();
});

function restoreTheme(){
  const t = localStorage.getItem('theme');
  if(t==='dark'){
    document.documentElement.setAttribute('data-theme','dark');
    document.getElementById('themeToggle').classList.add('on');
  }
}

function setupLogin(){
  document.getElementById('loginForm').addEventListener('submit', e=>{
    e.preventDefault();
    loginFirebase();
  });
}

function setupNavigation(){
  // Desktop sidebar
  document.querySelectorAll('.nav-item[data-page]').forEach(el=>{
    el.addEventListener('click', ()=> goPage(el.dataset.page));
  });
  // Mobile bottom nav
  document.querySelectorAll('.nav-tab[data-page]').forEach(el=>{
    el.addEventListener('click', ()=> goPage(el.dataset.page));
  });
}

function setupFilterChips(){
  document.querySelectorAll('.chip-group .chip').forEach(c=>{
    c.addEventListener('click',()=>{
      document.querySelectorAll('.chip-group .chip').forEach(x=>x.classList.remove('on'));
      c.classList.add('on');
      S.filters.period = c.dataset.p;
      const cdb = document.getElementById('customDateBox');
      if(c.dataset.p === 'custom'){
        cdb.style.display = 'grid';
      } else {
        cdb.style.display = 'none';
      }
    });
  });
}

// ===========================
// AUTH
// ===========================
async function loginFirebase(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPassword').value;
  if(!email||!pass){ showLoginError('يرجى إدخال البريد وكلمة المرور'); return; }

  showLoader('جاري تسجيل الدخول...');
  try {
    if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    S.auth = firebase.auth();
    S.db   = firebase.firestore();
    const cred = await S.auth.signInWithEmailAndPassword(email,pass);
    S.currentUser = cred.user;
    S.isDemoMode  = false;
    S.isConnected = true;
    showLoader('جاري تحميل البيانات...');
    await loadFromFirebase();
    hideLoader();
    launchApp();
    toast('تم تسجيل الدخول بنجاح', 'success');
  } catch(e){
    hideLoader();
    const msgs = {
      'auth/user-not-found':'البريد الإلكتروني غير مسجل',
      'auth/wrong-password':'كلمة المرور غير صحيحة',
      'auth/invalid-email':'صيغة البريد غير صحيحة',
      'auth/network-request-failed':'تحقق من الاتصال بالإنترنت'
    };
    showLoginError(msgs[e.code] || 'فشل تسجيل الدخول');
  }
}

function loginDemo(){
  S.isDemoMode = true; S.isConnected = false;
  showLoader('جاري التحضير...');
  loadStudents();
  setTimeout(()=>{ hideLoader(); launchApp(); toast('مرحباً — الوضع التجريبي نشط','info'); }, 800);
}

function showLoginError(msg){
  const el = document.getElementById('loginError');
  document.getElementById('loginErrorMsg').textContent = msg;
  el.style.display = 'flex';
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}

function launchApp(){
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appWrap').style.display = 'block';
  updateStatus();
  setTodayDate();
  renderAll();
}

function updateStatus(){
  const dot  = document.getElementById('statusDot');
  const txt  = document.getElementById('statusTxt');
  const pName= document.getElementById('profileName');
  const pEmail=document.getElementById('profileEmail');
  const pStat = document.getElementById('profileStatus');
  const fbStat= document.getElementById('fbStatus');
  const fbTgl = document.getElementById('fbToggle');
  const uName = document.getElementById('userNameTxt');

  if(S.isConnected){
    dot.className='status-dot connected'; txt.textContent='متصل بالبيانات';
    uName.textContent = S.currentUser?.email?.split('@')[0] || 'مستخدم';
    pName.textContent = S.currentUser?.email?.split('@')[0] || 'مستخدم';
    pEmail.textContent= S.currentUser?.email || '';
    pStat.className='profile-status live';
    pStat.innerHTML='<i class="fas fa-cloud"></i> متصل بـ Firebase';
    fbTgl.classList.add('on');
    fbStat.className='alert-box alert-success';
    fbStat.innerHTML='<i class="fas fa-circle-check"></i><span>متصل بـ Firebase — البيانات محفوظة على السحابة</span>';
  } else {
    dot.className='status-dot demo'; txt.textContent='وضع تجريبي';
    uName.textContent='مستخدم تجريبي';
    pName.textContent='مستخدم تجريبي';
    pEmail.textContent='—';
    pStat.className='profile-status demo';
    pStat.innerHTML='<i class="fas fa-flask"></i> وضع تجريبي';
    fbTgl.classList.remove('on');
    fbStat.className='alert-box alert-warn';
    fbStat.innerHTML='<i class="fas fa-triangle-exclamation"></i><span>أنت في الوضع التجريبي — سجّل الدخول للربط بـ Firebase</span>';
  }
  document.getElementById('mFabFilter')?.classList.toggle('active',
    S.filters.teacher||S.filters.platform||S.filters.subject||S.filters.province||S.filters.period!=='all'||S.filters.tPct!=null);
}

// ===========================
// FIREBASE OPS
// ===========================
async function loadFromFirebase(){
  try {
    const snap = await S.db.collection('students').where('userId','==',S.currentUser.uid).get();
    S.students=[];
    snap.forEach(d=> S.students.push({id:d.id,...d.data()}));
    const sdoc = await S.db.collection('settings').doc(S.currentUser.uid).get();
    if(sdoc.exists && sdoc.data().profits) S.profits = sdoc.data().profits;
  } catch(e){ toast('خطأ في تحميل البيانات','error'); }
}
async function fbSave(st){
  if(!S.isConnected||!S.db) return;
  try {
    const d={...st, userId:S.currentUser.uid, updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
    if(typeof st.id==='string') await S.db.collection('students').doc(st.id).set(d);
    else { const r=await S.db.collection('students').add(d); st.id=r.id; }
  } catch(e){ toast('خطأ Firebase: '+e.message,'error'); }
}
async function fbDelete(id){
  if(!S.isConnected||!S.db||typeof id!=='string') return;
  try { await S.db.collection('students').doc(id).delete(); } catch(e){}
}
async function fbSaveSettings(){
  if(!S.isConnected||!S.db) return;
  try { await S.db.collection('settings').doc(S.currentUser.uid).set({profits:S.profits},{merge:true}); } catch(e){}
}

// ===========================
// PAGE NAV
// ===========================
function goPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  document.querySelectorAll('.nav-item[data-page]').forEach(el=>{
    el.classList.toggle('active', el.dataset.page===name);
  });
  document.querySelectorAll('.nav-tab[data-page]').forEach(el=>{
    el.classList.toggle('active', el.dataset.page===name);
  });
  if(name==='analytics') setTimeout(renderAnalytics,120);
}

// ===========================
// STUDENT FORM
// ===========================
function setTodayDate(){
  document.getElementById('f_date').value = new Date().toISOString().split('T')[0];
}
function calcProfits(){
  const c1=+document.getElementById('f_c1').value||0;
  const c2=+document.getElementById('f_c2').value||0;
  const ex=+document.getElementById('f_exp').value||0;
  const net=(c1+c2)-ex;
  document.getElementById('f_net').value=net.toFixed(2);
  document.getElementById('f_tProfit').value=((net*S.profits.teacher)/100).toFixed(2);
  document.getElementById('f_pProfit').value=((net*S.profits.platform)/100).toFixed(2);
  document.getElementById('f_aProfit').value=((net*S.profits.admin)/100).toFixed(2);
  document.getElementById('tPctHint').innerHTML=`<i class="fas fa-percent" style="font-size:10px"></i> نسبة ${S.profits.teacher}%`;
  document.getElementById('pPctHint').innerHTML=`<i class="fas fa-percent" style="font-size:10px"></i> نسبة ${S.profits.platform}%`;
  document.getElementById('aPctHint').innerHTML=`<i class="fas fa-percent" style="font-size:10px"></i> نسبة ${S.profits.admin}%`;
}
function openStudentModal(){
  S.editId=null;
  document.getElementById('modalHeadTitle').textContent='إضافة طالب جديد';
  document.getElementById('f_name').value=''; document.getElementById('f_prov').value='';
  document.getElementById('f_subj').value=''; document.getElementById('f_teacher').value='';
  document.getElementById('f_platform').value=''; document.getElementById('f_library').value='';
  document.getElementById('f_code').value='';
  document.getElementById('f_c1').value='0'; document.getElementById('f_c2').value='0';
  document.getElementById('f_exp').value='0';
  setTodayDate(); calcProfits();
  document.getElementById('studentModal').classList.add('show');
}
function closeStudentModal(){ document.getElementById('studentModal').classList.remove('show'); }
async function saveStudent(){
  const name=document.getElementById('f_name').value.trim();
  const subj=document.getElementById('f_subj').value.trim();
  const code=document.getElementById('f_code').value.trim();
  const c1=document.getElementById('f_c1').value;
  const c2=document.getElementById('f_c2').value;
  if(!name||!subj||!code){ toast('يرجى ملء الحقول المطلوبة','warning'); return; }
  if(c1===''||c2===''){ toast('يرجى إدخال أسعار الكورسات','warning'); return; }
  const st={
    id:S.editId||Date.now(),
    name, province:document.getElementById('f_prov').value,
    date:document.getElementById('f_date').value,
    subject:subj, teacher:document.getElementById('f_teacher').value,
    platform:document.getElementById('f_platform').value,
    library:document.getElementById('f_library').value,
    subscriptionCode:code,
    course1:+c1||0, course2:+c2||0, expenses:+document.getElementById('f_exp').value||0,
    netTotal:+document.getElementById('f_net').value||0,
    teacherPercent:S.profits.teacher, teacherProfit:+document.getElementById('f_tProfit').value,
    platformPercent:S.profits.platform, platformProfit:+document.getElementById('f_pProfit').value,
    adminPercent:S.profits.admin, adminProfit:+document.getElementById('f_aProfit').value
  };
  if(S.editId){ const i=S.students.findIndex(x=>x.id===S.editId); S.students[i]=st; }
  else S.students.push(st);
  persistStudents();
  if(S.isConnected) await fbSave(st);
  closeStudentModal(); renderAll();
  toast(S.editId?'تم تحديث بيانات الطالب':'تمت إضافة الطالب بنجاح','success');
}
function editStudent(id){
  const st=S.students.find(s=>s.id===id); if(!st) return;
  S.editId=id;
  document.getElementById('modalHeadTitle').textContent='تعديل بيانات الطالب';
  document.getElementById('f_name').value=st.name;
  document.getElementById('f_prov').value=st.province||'';
  document.getElementById('f_date').value=st.date||'';
  document.getElementById('f_subj').value=st.subject;
  document.getElementById('f_teacher').value=st.teacher||'';
  document.getElementById('f_platform').value=st.platform||'';
  document.getElementById('f_library').value=st.library||'';
  document.getElementById('f_code').value=st.subscriptionCode||'';
  document.getElementById('f_c1').value=st.course1;
  document.getElementById('f_c2').value=st.course2;
  document.getElementById('f_exp').value=st.expenses;
  calcProfits();
  document.getElementById('studentModal').classList.add('show');
}

// ===========================
// CONFIRM DELETE
// ===========================
let _deleteId = null;
function requestDelete(id){
  const st = S.students.find(s=>s.id===id);
  if(!st) return;
  _deleteId = id;
  document.getElementById('confirmStudentName').textContent = st.name;
  document.getElementById('confirmOverlay').classList.add('show');
  document.getElementById('confirmDeleteBtn').onclick = executeDelete;
}
async function executeDelete(){
  if(!_deleteId) return;
  closeConfirm();
  const id = _deleteId; _deleteId = null;
  S.students = S.students.filter(s=>s.id!==id);
  persistStudents();
  if(S.isConnected) await fbDelete(id);
  renderAll();
  toast('تم حذف بيانات الطالب','success');
}
function closeConfirm(){
  document.getElementById('confirmOverlay').classList.remove('show');
  _deleteId=null;
}

// ===========================
// FILTER
// ===========================
function openFilterModal(){ document.getElementById('filterModal').classList.add('show'); }
function closeFilterModal(){ document.getElementById('filterModal').classList.remove('show'); }
function applyFilters(){
  S.filters.teacher  = document.getElementById('fl_teacher').value.trim();
  S.filters.platform = document.getElementById('fl_platform').value.trim();
  S.filters.subject  = document.getElementById('fl_subj').value.trim();
  S.filters.province = document.getElementById('fl_prov').value.trim();
  S.filters.from     = document.getElementById('fl_from').value;
  S.filters.to       = document.getElementById('fl_to').value;
  const tp=document.getElementById('fl_tPct').value;
  const pp=document.getElementById('fl_pPct').value;
  const ap=document.getElementById('fl_aPct').value;
  S.filters.tPct = tp!==''?+tp:null;
  S.filters.pPct = pp!==''?+pp:null;
  S.filters.aPct = ap!==''?+ap:null;
  const isActive=S.filters.teacher||S.filters.platform||S.filters.subject||
    S.filters.province||S.filters.period!=='all'||S.filters.tPct!=null||
    S.filters.pPct!=null||S.filters.aPct!=null;
  document.getElementById('filterBtn').classList.toggle('active',isActive);
  document.getElementById('mFabFilter')?.classList.toggle('active',isActive);
  closeFilterModal(); renderAll();
  toast('تم تطبيق الفلترة','success');
}
function clearFilters(){
  S.filters={teacher:'',platform:'',subject:'',province:'',period:'all',from:'',to:'',tPct:null,pPct:null,aPct:null};
  ['fl_teacher','fl_platform','fl_subj','fl_prov','fl_from','fl_to','fl_tPct','fl_pPct','fl_aPct']
    .forEach(id=>{document.getElementById(id).value='';});
  document.querySelectorAll('.chip-group .chip').forEach(c=>c.classList.remove('on'));
  document.querySelector('.chip[data-p="all"]').classList.add('on');
  document.getElementById('customDateBox').style.display='none';
  document.getElementById('filterBtn').classList.remove('active');
  document.getElementById('mFabFilter')?.classList.remove('active');
  renderAll();
  toast('تم مسح الفلاتر','info');
}
function getFiltered(){
  let d=[...S.students];
  if(S.filters.teacher) d=d.filter(s=>s.teacher?.toLowerCase().includes(S.filters.teacher.toLowerCase()));
  if(S.filters.platform) d=d.filter(s=>s.platform?.toLowerCase().includes(S.filters.platform.toLowerCase()));
  if(S.filters.subject) d=d.filter(s=>s.subject?.toLowerCase().includes(S.filters.subject.toLowerCase()));
  if(S.filters.province) d=d.filter(s=>s.province?.toLowerCase().includes(S.filters.province.toLowerCase()));
  if(S.filters.tPct!=null) d=d.filter(s=>s.teacherPercent===S.filters.tPct);
  if(S.filters.pPct!=null) d=d.filter(s=>s.platformPercent===S.filters.pPct);
  if(S.filters.aPct!=null) d=d.filter(s=>s.adminPercent===S.filters.aPct);
  const today=new Date(); today.setHours(0,0,0,0);
  if(S.filters.period==='today'){
    const t=today.toISOString().split('T')[0]; d=d.filter(s=>s.date===t);
  } else if(S.filters.period==='week'){
    const w=new Date(today); w.setDate(w.getDate()-7);
    d=d.filter(s=>s.date>=w.toISOString().split('T')[0]);
  } else if(S.filters.period==='month'){
    const m=new Date(today); m.setMonth(m.getMonth()-1);
    d=d.filter(s=>s.date>=m.toISOString().split('T')[0]);
  } else if(S.filters.period==='custom'){
    if(S.filters.from) d=d.filter(s=>s.date>=S.filters.from);
    if(S.filters.to)   d=d.filter(s=>s.date<=S.filters.to);
  }
  return d;
}

// ===========================
// RENDER
// ===========================
function renderAll(){
  const d=getFiltered();
  renderHomeStats(d);
  renderMiniTable(d);
  renderMainTable(d);
  if(document.getElementById('analytics').classList.contains('active')) renderAnalytics();
}
function renderHomeStats(d){
  const sales=d.reduce((s,x)=>s+(x.course1+x.course2),0);
  const net=d.reduce((s,x)=>s+x.netTotal,0);
  const tp=d.reduce((s,x)=>s+x.teacherProfit,0);
  const pp=d.reduce((s,x)=>s+x.platformProfit,0);
  const ap=d.reduce((s,x)=>s+x.adminProfit,0);
  set('h_students',d.length); set('h_sales',fmt(sales));
  set('h_net',fmt(net)); set('h_teacher',fmt(tp));
  set('h_platform',fmt(pp)); set('h_admin',fmt(ap));
}
function renderMiniTable(d){
  const recent=[...d].sort((a,b)=>b.date?.localeCompare(a.date)).slice(0,20);
  const tb=document.getElementById('miniTbody');
  if(!recent.length){ tb.innerHTML=emptyRow(5,'لا توجد بيانات'); return; }
  tb.innerHTML=recent.map(s=>`<tr>
    <td>${s.name}</td><td>${s.subject}</td>
    <td>${s.teacher||'—'}</td><td>${s.date||'—'}</td>
    <td><strong>${fmt(s.netTotal)}</strong></td>
  </tr>`).join('');
}
function renderMainTable(d,q=''){
  let rows=[...d].sort((a,b)=>b.date?.localeCompare(a.date));
  if(q) rows=rows.filter(s=>s.name.toLowerCase().includes(q.toLowerCase()));
  const tb=document.getElementById('mainTbody');
  set('tableCount',`${rows.length} طالب`);
  if(!rows.length){ tb.innerHTML=emptyRow(17,'لا توجد بيانات مطابقة'); return; }
  tb.innerHTML=rows.map((s,i)=>`<tr>
    <td>${i+1}</td><td>${s.name}</td>
    <td>${s.province||'—'}</td><td>${s.date||'—'}</td>
    <td>${s.subject}</td><td>${s.teacher||'—'}</td>
    <td>${s.platform||'—'}</td><td>${s.library||'—'}</td>
    <td>${s.subscriptionCode||'—'}</td>
    <td>${fmt(s.course1)}</td><td>${fmt(s.course2)}</td>
    <td>${fmt(s.expenses)}</td>
    <td><strong>${fmt(s.netTotal)}</strong></td>
    <td>${fmt(s.teacherProfit)}</td>
    <td>${fmt(s.platformProfit)}</td>
    <td>${fmt(s.adminProfit)}</td>
    <td><div class="td-actions">
      <button class="act-btn act-edit" onclick="editStudent(${JSON.stringify(s.id)})"><i class="fas fa-pen"></i></button>
      <button class="act-btn act-del"  onclick="requestDelete(${JSON.stringify(s.id)})"><i class="fas fa-trash"></i></button>
    </div></td>
  </tr>`).join('');
}
function searchTable(){ renderMainTable(getFiltered(), document.getElementById('tableSearchInp').value); }
function quickSearch(){
  const q=document.getElementById('quickSearchInp').value.toLowerCase();
  const rows=document.getElementById('miniTbody').querySelectorAll('tr');
  rows.forEach(r=>{ r.style.display=r.textContent.toLowerCase().includes(q)?'':'none'; });
}

// ===========================
// ANALYTICS
// ===========================
function renderAnalytics(){
  const d=getFiltered();
  if(!d.length){ clearAnalytics(); return; }
  const sales=d.reduce((s,x)=>s+(x.course1+x.course2),0);
  const net=d.reduce((s,x)=>s+x.netTotal,0);
  const tp=d.reduce((s,x)=>s+x.teacherProfit,0);
  const pp=d.reduce((s,x)=>s+x.platformProfit,0);
  const ap=d.reduce((s,x)=>s+x.adminProfit,0);
  set('a_students',d.length); set('a_sales',fmt(sales));
  set('a_net',fmt(net)); set('a_teacher',fmt(tp));
  set('a_platform',fmt(pp)); set('a_admin',fmt(ap));

  const tMap={},pMap={},sMap={},pvMap={};
  d.forEach(s=>{
    if(s.teacher) tMap[s.teacher]=(tMap[s.teacher]||0)+s.teacherProfit;
    if(s.platform) pMap[s.platform]=(pMap[s.platform]||0)+1;
    if(s.subject) sMap[s.subject]=(sMap[s.subject]||0)+1;
    if(s.province) pvMap[s.province]=(pvMap[s.province]||0)+1;
  });
  topOf(tMap,'a_topTeacher','a_topTeacherVal','مدرس بـ','دينار');
  topOf(pMap,'a_topPlatform','a_topPlatformVal','منصة بـ','طالب');
  topOf(sMap,'a_topSubject','a_topSubjectVal','مادة بـ','طالب');
  topOf(pvMap,'a_topProv','a_topProvVal','محافظة بـ','طالب');

  set('a_avg', fmt(net/d.length));
  const exp=d.reduce((s,x)=>s+x.expenses,0);
  set('a_expRatio', sales>0?((exp/sales)*100).toFixed(1)+'%':'0%');
  set('a_loss', d.filter(s=>s.netTotal<=0).length);
  set('a_weakPlat', Object.values(pMap).filter(v=>v<5).length);
  set('a_lowTeach', Object.values(tMap).filter(v=>v<10000).length);

  drawCharts(d,tp,pp,ap,tMap,pMap,sMap,pvMap);
}
function topOf(map,nId,vId,pre,unit){
  if(!Object.keys(map).length){ set(nId,'—'); set(vId,''); return; }
  const top=Object.keys(map).reduce((a,b)=>map[a]>map[b]?a:b);
  set(nId,top); set(vId,`${map[top].toFixed?map[top].toFixed(0):map[top]} ${unit}`);
}
function clearAnalytics(){
  ['a_students','a_sales','a_net','a_teacher','a_platform','a_admin',
   'a_topTeacher','a_topPlatform','a_topSubject','a_topProv',
   'a_avg','a_loss','a_weakPlat','a_lowTeach'].forEach(id=>set(id,'0'));
  set('a_expRatio','0%');
  Object.values(S.charts).forEach(c=>c?.destroy());
  S.charts={};
}
function drawCharts(d,tp,pp,ap,tMap,pMap,sMap,pvMap){
  Object.values(S.charts).forEach(c=>c?.destroy()); S.charts={};
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  const tc = isDark?'#F1E194':'#5B0E14';
  const gc = isDark?'rgba(61,20,23,0.5)':'rgba(229,216,138,0.5)';
  const base={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:tc,font:{family:'Cairo'}}}}};
  const ax={ticks:{color:tc,font:{family:'Cairo'}},grid:{color:gc}};

  // Pie
  const pc=document.getElementById('cPie');
  if(pc) S.charts.pie=new Chart(pc,{type:'pie',data:{labels:['المدرسين','المنصة','الإدارة'],datasets:[{data:[tp,pp,ap],backgroundColor:['#6366f1','#ec4899','#7c3aed'],borderWidth:2,borderColor:isDark?'#1E0608':'#fff'}]},options:{...base,plugins:{...base.plugins,legend:{...base.plugins.legend,position:'bottom'}}}});

  // Line
  const mMap={};
  d.forEach(s=>{ const m=s.date?.substring(0,7); if(m) mMap[m]=(mMap[m]||0)+s.netTotal; });
  const months=Object.keys(mMap).sort();
  const lc=document.getElementById('cLine');
  if(lc) S.charts.line=new Chart(lc,{type:'line',data:{labels:months,datasets:[{label:'الأرباح الشهرية',data:months.map(m=>mMap[m]),borderColor:'#4f46e5',backgroundColor:'rgba(79,70,229,0.08)',tension:.4,fill:true,pointRadius:4,pointBackgroundColor:'#4f46e5'}]},options:{...base,scales:{x:ax,y:ax},plugins:{...base.plugins,legend:{display:false}}}});

  const sorted=(m,n)=>Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,n);
  const bOpts=(label,color)=>({...base,indexAxis:'y',scales:{x:ax,y:ax},plugins:{...base.plugins,legend:{display:false},tooltip:{callbacks:{label:v=>`${v.raw} ${label}`}}}});

  const tc2=document.getElementById('cTeachers');
  if(tc2){const e=sorted(tMap,10);S.charts.teach=new Chart(tc2,{type:'bar',data:{labels:e.map(x=>x[0]),datasets:[{data:e.map(x=>x[1]),backgroundColor:'#6366f1',borderRadius:5}]},options:bOpts('دينار','#6366f1')});}

  const pc2=document.getElementById('cPlatforms');
  if(pc2){const e=sorted(pMap,10);S.charts.plat=new Chart(pc2,{type:'bar',data:{labels:e.map(x=>x[0]),datasets:[{data:e.map(x=>x[1]),backgroundColor:'#ec4899',borderRadius:5}]},options:bOpts('طالب','#ec4899')});}

  const sc=document.getElementById('cSubjects');
  if(sc){const e=sorted(sMap,5);S.charts.subj=new Chart(sc,{type:'doughnut',data:{labels:e.map(x=>x[0]),datasets:[{data:e.map(x=>x[1]),backgroundColor:['#4f46e5','#10b981','#f59e0b','#ef4444','#8b5cf6'],borderWidth:2,borderColor:isDark?'#1E0608':'#fff'}]},options:{...base,plugins:{...base.plugins,legend:{...base.plugins.legend,position:'bottom'}}}});}

  const pvc=document.getElementById('cProvinces');
  if(pvc){const e=sorted(pvMap,5);S.charts.prov=new Chart(pvc,{type:'bar',data:{labels:e.map(x=>x[0]),datasets:[{data:e.map(x=>x[1]),backgroundColor:'#10b981',borderRadius:5}]},options:{...base,scales:{x:ax,y:ax},plugins:{...base.plugins,legend:{display:false}}}});}
}

// ===========================
// SETTINGS
// ===========================
function loadSettings(){
  const p=localStorage.getItem('profits');
  if(p) S.profits=JSON.parse(p);
  document.getElementById('s_teacher').value=S.profits.teacher;
  document.getElementById('s_platform').value=S.profits.platform;
  document.getElementById('s_admin').value=S.profits.admin;
  const org=localStorage.getItem('orgName');
  if(org) document.getElementById('s_orgName').value=org;
}
function saveProfitSettings(){
  const t=+document.getElementById('s_teacher').value||0;
  const p=+document.getElementById('s_platform').value||0;
  const a=+document.getElementById('s_admin').value||0;
  if(Math.abs(t+p+a-100)>0.01){ toast('مجموع النسب يجب أن يساوي 100%','warning'); return; }
  S.profits={teacher:t,platform:p,admin:a};
  localStorage.setItem('profits',JSON.stringify(S.profits));
  if(S.isConnected) fbSaveSettings();
  toast('تم حفظ نسب الأرباح بنجاح','success');
}
function saveOrgSettings(){
  localStorage.setItem('orgName',document.getElementById('s_orgName').value);
  toast('تم حفظ الإعدادات','success');
}
function toggleTheme(){
  const th=document.getElementById('themeToggle');
  const isDark=th.classList.toggle('on');
  document.documentElement.setAttribute('data-theme',isDark?'dark':'light');
  if(!isDark) document.documentElement.removeAttribute('data-theme');
  localStorage.setItem('theme',isDark?'dark':'light');
  if(document.getElementById('analytics').classList.contains('active')) setTimeout(renderAnalytics,120);
}
function toggleFirebase(){
  if(!S.isConnected){
    document.getElementById('appWrap').style.display='none';
    document.getElementById('loginScreen').style.display='flex';
    toast('سجّل الدخول للربط بـ Firebase','info');
  } else { toast('أنت متصل بالفعل','info'); }
}

// ===========================
// EXPORT CSV (FIXED)
// ===========================
function exportCSV(){
  const d=getFiltered();
  if(!d.length){ toast('لا توجد بيانات للتصدير','warning'); return; }
  const sep='\t'; // Tab separator for proper Excel column parsing
  const headers=['ID','الاسم الثلاثي','المحافظة','التاريخ','المادة','المدرس','المنصة','المكتبة','كود الاشتراك','سعر الكورس 1','سعر الكورس 2','الصرفيات','المجموع الصافي','ربح المدرس','ربح المنصة','ربح الإدارة'];
  const esc=v=>{
    const s=String(v==null?'':v).replace(/\t/g,' ');
    return s;
  };
  const rows=d.map((s,i)=>[
    i+1, esc(s.name), esc(s.province||''), esc(s.date||''),
    esc(s.subject), esc(s.teacher||''), esc(s.platform||''), esc(s.library||''),
    esc(s.subscriptionCode||''), s.course1, s.course2, s.expenses,
    s.netTotal, s.teacherProfit, s.platformProfit, s.adminProfit
  ].join(sep));
  const content='\uFEFF'+headers.join(sep)+'\n'+rows.join('\n');
  const blob=new Blob([content],{type:'text/tab-separated-values;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`SPMS-${new Date().toISOString().split('T')[0]}.tsv`;
  a.click(); URL.revokeObjectURL(url);
  toast('تم تصدير البيانات بنجاح — افتح الملف بـ Excel','success');
}

// ===========================
// LOCAL STORAGE
// ===========================
function persistStudents(){ localStorage.setItem('students',JSON.stringify(S.students)); }
function loadStudents(){
  const s=localStorage.getItem('students');
  if(s) S.students=JSON.parse(s);
}

// ===========================
// UI HELPERS
// ===========================
function showLoader(msg='جاري التحميل...'){
  document.getElementById('loaderMsg').textContent=msg;
  document.getElementById('loader').classList.add('show');
}
function hideLoader(){ document.getElementById('loader').classList.remove('show'); }
function toast(msg,type='success'){
  const icons={success:'fa-circle-check',error:'fa-circle-xmark',info:'fa-circle-info',warning:'fa-triangle-exclamation'};
  const el=document.createElement('div');
  el.className=`toast toast-${type}`;
  el.innerHTML=`<i class="fas ${icons[type]}"></i><span>${msg}</span>`;
  document.getElementById('toastWrap').appendChild(el);
  requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ el.classList.add('show'); }); });
  setTimeout(()=>{
    el.classList.remove('show');
    setTimeout(()=>el.remove(),400);
  },3000);
}
function set(id,v){ const el=document.getElementById(id); if(el) el.textContent=v; }
function fmt(n){ return Number(n||0).toLocaleString('ar-IQ'); }
function emptyRow(cols,msg){
  return `<tr class="empty-row"><td colspan="${cols}">
    <div class="empty-state">
      <i class="fas fa-inbox"></i><p>${msg}</p>
    </div></td></tr>`;
}
</script>
</body>
</html>